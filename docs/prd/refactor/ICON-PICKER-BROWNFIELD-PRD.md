# IconPicker 元件重構 - Brownfield PRD

**專案類型**：Brownfield（現有系統重構）  
**文件版本**：1.0  
**建立日期**：2025-08-17  
**負責人**：開發團隊  
**優先級**：P0（第一優先）  

## 📋 執行摘要

### 專案背景
IconPicker 是 PurpleDesk 系統中的核心 UI 元件，目前包含 1,379 行程式碼，負責處理 5 種不同類型的圖標選擇（文字圖標、Emoji、HeroIcons、Bootstrap Icons、圖片上傳）。隨著系統即將廣泛使用此元件，急需進行重構以提升可維護性和可測試性。

### 業務價值
- **短期價值**：降低開發維護成本，提升開發效率，建立測試基礎
- **長期價值**：為系統規模化使用做準備，支援未來功能擴展，從檔案讀取轉向 API 讀取

### 關鍵成功因素
1. **零破壞性變更**：UI/UX 介面保持 100% 相容，絕對不能改變
2. **漸進式交付**：每個階段都可獨立驗證和回滾
3. **測試覆蓋完整**：建立堅實的測試基礎，測試覆蓋率越高越好

## 🔍 現況分析

### 技術債務

| 問題 | 現況 | 影響 | 優先級 |
|------|------|------|--------|
| 單一檔案過大 | 1,379 行程式碼 | 極難理解和維護 | P0 |
| 零測試覆蓋 | 完全沒有測試 | 修改風險極高 | P0 |
| 責任混雜 | 5種圖標類型 + UI邏輯混合 | 難以擴展新功能 | P1 |
| 資料來源耦合 | 前端設定檔 + API混合 | 難以統一從 API 載入 | P1 |
| 搜尋邏輯複雜 | 跨類型搜尋邏輯混雜 | 維護困難 | P1 |

### 使用範圍分析
- **當前使用**：User Profile 頁面（頭像選擇）
- **計劃使用**：所有需要圖標選擇的編輯頁面（組織Logo、團隊圖標等）
- **預估影響**：未來將影響 20+ 頁面，成為核心 UI 元件
- **使用者影響**：目前系統仍在開發中，無外部使用者，風險可控

### 技術架構現況

```
當前架構問題：
IconPicker.vue (1,379 行)
├── TextIcon 處理邏輯 (150+ 行)
├── Emoji 處理邏輯 (300+ 行)
├── HeroIcons 處理邏輯 (200+ 行)
├── Bootstrap Icons 處理邏輯 (300+ 行)
├── 圖片上傳處理邏輯 (150+ 行)
├── 搜尋功能邏輯 (100+ 行)
├── 顏色選擇器邏輯 (200+ 行)
├── UI 定位邏輯 (150+ 行)
└── 事件處理邏輯 (100+ 行)
```

### 維護痛點
1. **程式碼過長**：單一檔案 1,379 行，極難閱讀和理解
2. **功能耦合**：5種圖標類型邏輯互相糾纏，修改一處影響全域
3. **測試困難**：沒有測試覆蓋，修改風險極高
4. **擴展困難**：新增圖標類型需要修改核心檔案
5. **資料載入混亂**：emoji 從 API 載入，其他從前端設定，不一致

## 🎯 解決方案

### 重構策略
採用「絞殺者模式」(Strangler Pattern) + TDD 開發：
1. **保留原版運作**：建立 IconPickerOri.vue 作為備份
2. **建立 features 結構**：集中管理所有相關功能
3. **漸進式拆分**：一次只重構一個功能模組
4. **隨時可回滾**：確保每個步驟都可以安全回退

### 目標技術架構

```
重構後架構：
features/icon-picker/
├── components/
│   ├── shared/
│   │   └── VirtualScrollGrid.vue # 共用虛擬滾動網格
│   ├── IconPickerSearch.vue      # 搜尋元件（僅搜尋當前頁籤）
│   ├── TextIconPanel.vue         # 文字圖標面板
│   ├── EmojiPanel.vue            # Emoji 面板（使用 VirtualScrollGrid）
│   ├── IconLibraryPanel.vue      # 圖標庫面板（HeroIcon + Bootstrap Icon）
│   ├── ImageUploadPanel.vue      # 圖片上傳面板
│   └── ColorPickerPanel.vue      # 顏色選擇器面板
├── composables/
│   ├── useIconPickerState.js     # 狀態管理
│   ├── useIconPosition.js        # 定位計算邏輯
│   ├── useIconSelection.js       # 選擇邏輯
│   └── useColorManagement.js     # 顏色管理邏輯
├── services/
│   └── IconDataLoader.js         # 統一資料載入服務
└── tests/
    ├── components/               # 元件測試
    ├── composables/             # 邏輯測試
    └── services/                # 服務測試
```

### 重構原則

#### 1. 介面完全不變 (絕對優先)
- ✅ HTML 結構保持一致
- ✅ CSS 類別名稱不變
- ✅ 事件處理行為一致
- ✅ 用戶操作流程完全相同
- ✅ 視覺效果完全一致

#### 2. 功能完全相容
- ✅ 5 種圖標類型都正常運作
- ✅ 搜尋功能只搜尋當前頁籤
- ✅ 顏色選擇器功能不變
- ✅ 拖放上傳功能不變
- ✅ 定位邏輯保持一致

#### 3. 漸進式重構
- ✅ 每次只重構一個功能模組
- ✅ 每個步驟都可獨立測試
- ✅ 隨時可以回滾到原版
- ✅ TDD 驅動開發流程

## 📋 實施計劃

### Phase 0: 建立安全網（第1週）
**目標**：確保重構過程絕對安全

1. **建立備份版本**
   - 複製 `IconPicker.vue` → `IconPickerOri.vue`
   - 建立版本切換機制（開發環境）
   - 確保原版隨時可用

2. **建立 features 結構**
   ```bash
   features/icon-picker/
   ├── components/
   ├── composables/
   ├── services/
   └── tests/
   ```

3. **建立測試基礎架構**
   - 安裝 Vitest 測試框架（如未安裝）
   - 建立測試配置
   - 建立第一個基礎測試

### Phase 1: 服務層建立（第2週）
**目標**：統一資料管理，準備拆分

1. **建立 IconDataLoader 服務**
   - 整合現有 IconService
   - 提供三種載入方法：
     * `getEmojiData()` - 從後端 API 載入
     * `getIconLibraryData()` - 合併 HeroIcon + Bootstrap Icon（前端檔案）
   - 保持現有資料格式完全不變
   - 建立完整測試覆蓋

2. **建立 IconPickerSearch 元件**
   - 從原始碼抽取搜尋邏輯
   - 功能：僅搜尋當前頁籤的圖標
   - 保持搜尋行為完全一致
   - 建立搜尋功能測試

### Phase 2: 圖標面板拆分（第3-4週）
**目標**：模組化各類型圖標處理

依序拆分（每個面板獨立完成並測試）：

1. **VirtualScrollGrid（共用元件）**
   - 建立虛擬滾動網格基礎元件
   - 負責：虛擬滾動邏輯、網格佈局、效能優化
   - 不負責：項目內容渲染、業務邏輯
   - 建立虛擬滾動測試

2. **TextIconPanel**
   - 抽取 `activeTab === 'initials'` 的所有邏輯
   - 保持文字輸入、預覽、顏色計算邏輯不變
   - 建立元件測試

3. **EmojiPanel**
   - 抽取 `activeTab === 'emoji'` 的所有邏輯
   - 使用 VirtualScrollGrid + IconDataLoader
   - 負責：Emoji 顯示、膚色處理、選擇邏輯
   - 建立 emoji 載入和顯示測試

4. **IconLibraryPanel**
   - 抽取 Icons 頁籤相關邏輯（HeroIcon + Bootstrap Icon）
   - 使用 VirtualScrollGrid + IconDataLoader
   - 負責：Icon 顯示、樣式切換、選擇邏輯
   - 建立圖標載入和選擇測試

5. **ImageUploadPanel**
   - 抽取圖片上傳相關邏輯
   - 保持拖放功能、檔案驗證邏輯
   - 建立上傳功能測試

6. **ColorPickerPanel**
   - 抽取顏色選擇器邏輯
   - 保持所有顏色選項和計算邏輯
   - 建立顏色選擇測試

### Phase 3: 邏輯抽離（第5週）
**目標**：提取可重用邏輯

1. **建立 Composables**
   - `useIconPickerState.js`：狀態管理
   - `useIconPosition.js`：定位計算
   - `useIconSelection.js`：選擇邏輯
   - `useColorManagement.js`：顏色管理

2. **重構主 IconPicker**
   - 整合所有子元件
   - 使用 composables 管理邏輯
   - 確保事件委派正確

### Phase 4: 整合測試與優化（第6週）
**目標**：確保完整性和效能

1. **整合測試**
   - 建立 E2E 測試
   - A/B 對比測試（新舊版本）
   - 視覺回歸測試

2. **效能優化**
   - 檢查載入效能
   - 記憶體使用優化
   - 虛擬滾動優化

3. **文件撰寫**
   - 元件使用文件
   - API 文件
   - 維護指南

## ⚠️ 風險管理

### 高風險項目

| 風險 | 可能性 | 影響程度 | 緩解策略 |
|------|--------|----------|----------|
| UI 不一致 | 低 | 極高 | 視覺回歸測試、像素級比對、保留原版備份 |
| 功能遺漏 | 中 | 高 | 完整 E2E 測試、功能檢查清單、逐步驗證 |
| 效能下降 | 低 | 中 | 效能基準測試、載入時間監控 |
| 測試不足 | 中 | 中 | 強制 TDD 流程、測試覆蓋率檢查 |

### 緊急應變計劃
1. **立即回滾**：切換回 IconPickerOri.vue
2. **階段性回滾**：回到上一個穩定的拆分階段
3. **問題隔離**：關閉有問題的新功能，使用原有邏輯

## 📊 成功指標

### 必要指標（不可妥協）
- ✅ **UI/UX 100% 相容性**：介面完全一致
- ✅ **功能 100% 相容性**：所有現有功能正常運作
- ✅ **零錯誤**：無 console 錯誤或運行時錯誤
- ✅ **可回滾性**：隨時可安全切換回原版

### 目標指標
- 📊 **測試覆蓋率**：> 80%（越高越好）
- 📊 **單一檔案大小**：< 300 行
- 📊 **元件數量**：8-12 個合理拆分
- 📊 **新功能開發時間**：可在 2 小時內新增圖標類型

### 品質指標
- 🎯 **程式碼可讀性**：每個元件職責單一清晰
- 🎯 **維護效率**：修改一個功能不影響其他功能
- 🎯 **開發體驗**：有完整的類型提示和文件

## ✅ 驗收標準

### 功能驗收標準
- [ ] **文字圖標**：輸入、預覽、顏色計算都正常
- [ ] **Emoji 選擇**：載入、搜尋、膚色選擇都正常
- [ ] **圖標庫**：HeroIcon + Bootstrap Icon 載入、樣式切換都正常
- [ ] **圖片上傳**：拖放、檔案驗證、預覽都正常
- [ ] **搜尋功能**：只搜尋當前頁籤，結果正確
- [ ] **顏色選擇**：所有顏色選項和計算都正常
- [ ] **定位邏輯**：面板定位和響應式調整都正常
- [ ] **虛擬滾動**：大量項目滾動流暢，效能正常

### 技術驗收標準
- [ ] **測試覆蓋率**：達到設定目標
- [ ] **程式碼審查**：所有程式碼通過審查
- [ ] **效能基準**：載入時間不超過原版
- [ ] **記憶體使用**：不超過原版記憶體消耗
- [ ] **無警告錯誤**：開發和生產環境都無 console 輸出

### 業務驗收標準
- [ ] **使用者體驗**：操作流程完全一致
- [ ] **視覺一致性**：UI 完全一致，無視覺差異
- [ ] **相容性**：在所有目標瀏覽器正常運作
- [ ] **部署就緒**：可順利部署到生產環境

### 維護性驗收標準
- [ ] **文件完整**：有完整的使用和維護文件
- [ ] **測試完備**：有足夠的測試保護修改
- [ ] **架構清晰**：新手可以快速理解架構
- [ ] **擴展容易**：可以輕鬆新增新的圖標類型

## 📚 相關文件

### 技術規範
- [圖標系統完整規範](/docs/prd/ICON-SPEC.md)
- [主架構系統文件](/docs/prd/MAIN.md)
- [TDD 開發規範](/docs/TDD.md)

### 開發指南
- [專案開發原則](/CLAUDE.md)
- Vue 3 組合式 API 最佳實踐
- Vitest 測試框架使用指南

---

**最後更新**：2025-08-17  
**下次審查**：Phase 1 完成後（預計第2週末）  
**負責人**：開發團隊  
**狀態**：已批准，等待開始實施  